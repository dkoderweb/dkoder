<!DOCTYPE html>
<html>
<head>
    <title>Trading Signal Monitor</title>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.21/css/jquery.dataTables.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.21/js/jquery.dataTables.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <style>
        body { padding: 20px; font-family: Arial, sans-serif; }
        .container { max-width: 1200px; margin: 0 auto; }
        .status { margin: 20px 0; padding: 10px; background: #f5f5f5; }
        .balance { font-weight: bold; }
        #tradeTable { width: 100%; margin-top: 20px; }
        .profit { color: green; }
        .loss { color: red; }
        #loginSection { text-align: center; margin: 20px 0; }
        .button { 
            padding: 10px 20px; 
            background: #4285f4; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
        }
        .error { color: red; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Trading Signal Monitor</h1>
        
        <div id="loginSection">
            <button id="authorize_button" class="button">Sign in with Google</button>
            <button id="signout_button" class="button" style="display: none;">Sign Out</button>
        </div>

        <div class="status">
            Current Balance: <span class="balance">0.00</span> USDT
            <br>
            Status: <span id="tradingStatus">Please sign in to start monitoring</span>
            <div id="errorMsg" class="error"></div>
        </div>

        <table id="tradeTable">
            <thead>
                <tr>
                    <th>Timestamp</th>
                    <th>Action</th>
                    <th>Price</th>
                    <th>Symbol</th>
                    <th>P&L</th>
                    <th>Balance</th>
                    <th>Status</th>
                    <th>Price Diff</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        // Trading state
        const state = {
            balance: 0,
            waitingForExit: false,
            currentTrade: null,
            entryPrice: null,
            table: null,
            lastEmailId: null,
            gapiInited: false,
            gisInited: false,
            tokenClient: null
        };

        // Gmail API configuration
        const CLIENT_ID = '407854156386-kut81124teer69rn2vphermh4lanp3an.apps.googleusercontent.com'; // Replace with your Gmail API client ID
        const API_KEY = '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'; // Replace with your Gmail API key
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest';
        const SCOPES = 'https://www.googleapis.com/auth/gmail.readonly';

        // Initialize the application
        async function initializeApp() {
            state.table = $('#tradeTable').DataTable({
                order: [[0, 'desc']],
                pageLength: 25,
                columns: [
                    { data: 'timestamp' },
                    { data: 'action' },
                    { data: 'price' },
                    { data: 'symbol' },
                    {
                        data: 'pnl',
                        render: function (data) {
                            const cls = parseFloat(data) >= 0 ? 'profit' : 'loss';
                            return `<span class="${cls}">${parseFloat(data).toFixed(2)}</span>`;
                        }
                    },
                    { data: 'balance' },
                    { data: 'status' },
                    { data: 'priceDiff' }
                ]
            });

            await initializeGoogleAuth(); // Wait for Google Auth initialization
        }


        // Initialize Google Auth
        // Initialize Google Auth
        async function initializeGoogleAuth() {
            // Load the gapi client library with a callback to initialize the client
            gapi.load('client:auth2', async function () {
                await initializeGapiClient(); // Ensure gapi.client is initialized
                
                state.tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: handleAuthResponse
                });

                document.getElementById('authorize_button').onclick = handleAuthClick;
                document.getElementById('signout_button').onclick = handleSignoutClick;

                const savedToken = localStorage.getItem('access_token');
                if (savedToken) {
                    gapi.client.setToken({ access_token: savedToken });
                    document.getElementById('authorize_button').style.display = 'none';
                    document.getElementById('signout_button').style.display = 'block';
                    startMonitoring();
                }
            });
        }



        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: [DISCOVERY_DOC],
            });
        }


        // Handle auth click
        function handleAuthClick() {
            state.tokenClient.requestAccessToken();
        }

        // Handle signout click
        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                localStorage.removeItem('access_token'); // Clear the token from localStorage
                document.getElementById('authorize_button').style.display = 'block';
                document.getElementById('signout_button').style.display = 'none';
                $('#tradingStatus').text('Please sign in to start monitoring');
            }
        }

        // Handle auth response
        function handleAuthResponse(response) {
            if (response.error !== undefined) {
                throw response;
            }
            // Save the token to localStorage
            localStorage.setItem('access_token', gapi.client.getToken().access_token);

            document.getElementById('authorize_button').style.display = 'none';
            document.getElementById('signout_button').style.display = 'block';
            startMonitoring();
        }

        // Function to fetch emails from Gmail
        async function fetchTradingViewSignal() {
            try {
                const query = 'from:noreply@tradingview.com'; // Fetch emails from this sender
                const response = await gapi.client.gmail.users.messages.list({
                    userId: 'me',
                    q: query,
                    maxResults: 1 // Fetch the most recent email
                });

                if (!response.result.messages || !response.result.messages.length) {
                    console.log('No emails found.');
                    return null;
                }

                const messageId = response.result.messages[0].id;

                // Skip already processed emails
                if (messageId === state.lastEmailId) {
                    console.log('No new email to process. ID:', messageId);
                    return null;
                }

                state.lastEmailId = messageId; // Update the last processed email ID

                const message = await gapi.client.gmail.users.messages.get({
                    userId: 'me',
                    id: messageId
                });

                const body = message.result.snippet; // Email snippet
                console.log('Fetched Email Body:', body);

                // Regex to extract action, price, and symbol
                const signalMatch = body.match(/(Buy|Sell|Take Partial Profit)[^,]*,?\s*Close = ([\d.]+)\s*Symbol = ([A-Za-z0-9.]+)/);

                if (signalMatch) {
                    console.log('Signal Match:', signalMatch);
                    return {
                        action: signalMatch[1],
                        close: signalMatch[2],
                        symbol: signalMatch[3]
                    };
                }

                console.log('No valid signal found in email.');
                return null;
            } catch (error) {
                console.error('Error fetching emails:', error);
                $('#errorMsg').text('Error fetching emails: ' + error.message);
                return null;
            }
        }



        // Function to log trades
        function logTrade(action, price, symbol, orderType = 'entry', entryPrice = null) {
            let pnl = 0;
            let priceDiff = 'N/A';
            
            if (action === 'Buy') {
                pnl = -parseFloat(price);
            } else if (action === 'Sell') {
                pnl = parseFloat(price);
            } else if (action === 'Take Partial Profit') {
                pnl = parseFloat(price);
                priceDiff = Math.abs(parseFloat(price) - parseFloat(entryPrice)).toFixed(2);
                orderType = 'exit';
            }
            
            if (orderType === 'exit' && entryPrice !== null) {
                priceDiff = Math.abs(parseFloat(price) - parseFloat(entryPrice)).toFixed(2);
            }
            
            state.balance += pnl;
            
            state.table.row.add({
                timestamp: new Date().toLocaleString(),
                action: action,
                price: parseFloat(price).toFixed(2),
                symbol: symbol,
                pnl: pnl.toFixed(2),
                balance: state.balance.toFixed(2),
                status: orderType === 'entry' ? 'Open' : 'Closed',
                priceDiff: priceDiff
            }).draw(false);

            $('.balance').text(state.balance.toFixed(2));
        }

        // Main monitoring loop
        async function startMonitoring() {
            $('#tradingStatus').text('Monitoring for signals...');
            
            setInterval(async () => {
                const signal = await fetchTradingViewSignal();

                if (signal) {
                    $('#tradingStatus').text(`Processing signal: ${signal.action} ${signal.symbol} @ ${signal.close}`);

                    if ((signal.action === 'Buy' || signal.action === 'Sell') && !state.waitingForExit) {
                        logTrade(signal.action, signal.close, signal.symbol, 'entry');
                        state.currentTrade = signal.action;
                        state.waitingForExit = true;
                        state.entryPrice = signal.close;
                    }
                    else if (signal.action === 'Take Partial Profit' && state.waitingForExit) {
                        logTrade(signal.action, signal.close, signal.symbol, 'exit', state.entryPrice);
                        state.currentTrade = null;
                        state.waitingForExit = false;
                        state.entryPrice = null;
                    }
                    else if (state.currentTrade === 'Buy' && signal.action === 'Sell' && state.waitingForExit) {
                        logTrade('Sell', signal.close, signal.symbol, 'exit', state.entryPrice);
                        logTrade('Sell', signal.close, signal.symbol, 'entry');
                        state.currentTrade = signal.action;
                        state.entryPrice = signal.close;
                    }
                    else if (state.currentTrade === 'Sell' && signal.action === 'Buy' && state.waitingForExit) {
                        logTrade('Buy', signal.close, signal.symbol, 'exit', state.entryPrice);
                        logTrade('Buy', signal.close, signal.symbol, 'entry');
                        state.currentTrade = signal.action;
                        state.entryPrice = signal.close;
                    }
                }
            }, 5000); // Check every 5 seconds
        }

        // Initialize when document is ready
        $(document).ready(initializeApp);
    </script>
</body>
</html>
